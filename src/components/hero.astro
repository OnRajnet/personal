---
import { Picture } from "astro:assets";
import personalImage from "assets/portrait.jpg"
import Link from "./ui/link.astro";
import Button from "./ui/button.astro";
import { Icon } from "astro-icon/components";
---

<main class="grid lg:grid-cols-2 place-items-center pt-16 pb-8 md:pt-12 md:pb-24">
  <div class="py-6 md:order-1 hidden md:block">
    <Picture
      src={personalImage}
      alt="Ondřej Rajnet"
      widths={[200, 400, 600]}
      sizes="(max-width: 800px) 100vw, 620px"
      loading="eager"
      formats={['avif', 'webp']}
    />
  </div>
  <div>
    <h1 class="text-5xl lg:text-6xl xl:text-7xl font-bold lg:tracking-tight xl:tracking-tighter">
      Jmenuji se Ondřej Rajnet
    </h1>
    <p class="text-lg mt-4 text-slate-600 max-w-xl">
      Jsem finanční průvodce, který pomáhá lidem zlepšit jejich vztah k penězům a dosáhnout finanční nezávislosti. Sdílím své zkušenosti a nabízím komplexní spolupráci včetně vzdělávání, motivace a individuálního poradenství.
    </p>

    <div id="status-message" class:list={["text-lg mt-4 max-w-xl hidden"]}></div>

   <div id="error-message" class:list={["text-lg mt-4 text-red-500 max-w-xl hidden"]}></div>

    <form 
      class="mt-6 flex flex-col sm:flex-row gap-3"
      method="POST"
      id="email-form"
    >
      <input
        type="text"
        placeholder="E-mail"
        required
        class="w-full px-4 py-3 border-2 placeholder:text-gray-800 rounded-md outline-none focus:ring-4 border-gray-300 focus:border-gray-600 ring-gray-100"
        name="recipient"
      />
      <input type="hidden" name="subject" value="E-BOOK ZDARMA" />

      <Button type="submit" size="md" block>
        E-BOOK ZDARMA
      </Button>
    </form>

    <div class="mt-2">
      <Link
        size="lg"
        style="outline"
        rel="noopener"
        href="#"
        class="flex gap-1 items-center justify-center"
        target="_blank">
        <Icon class="text-black w-4 h-4" name="bx:bxs-video" />
        Úvodní video
      </Link>
    </div>
  </div>
</main>

<script>
  const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

function isValidEmail(email: string): boolean {
  return EMAIL_REGEX.test(email);
}

  const form = document.getElementById('email-form') as HTMLFormElement;
  const statusMessage = document.getElementById('status-message');
  const errorMessage = document.getElementById('error-message');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const email = formData.get('recipient') as string;

    // Clear previous messages
    statusMessage?.classList.add('hidden');
    errorMessage?.classList.add('hidden');
    errorMessage?.classList.remove('text-red-500', 'text-green-500');

    // Validate email
    if (email && !isValidEmail(email)) {
      errorMessage!.textContent = "Neplatný e-mail";
      errorMessage?.classList.remove('hidden');
      errorMessage?.classList.add('text-red-500');
      return;
    }

    try {
      const response = await fetch('/api/send-email', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        statusMessage!.textContent = "Email byl odeslán.";
        statusMessage?.classList.remove('hidden');
        statusMessage?.classList.add('text-green-500');
        form.reset();
      } else {
        throw new Error(result.error || 'Something went wrong');
      }
    } catch (error) {
      errorMessage!.textContent = "Něco se pokazilo!!!";
      errorMessage?.classList.remove('hidden');
      errorMessage?.classList.add('text-red-500');
    }
  });
</script>
